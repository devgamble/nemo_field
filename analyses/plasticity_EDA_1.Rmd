---
title: "Plasticity_EDA_1"
author: "Devin Gamble"
date: "2022-10-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Description:**  
This .Rmd will include exploratory data analyses (EDA) on the phenotypic plasticity of traits measured in four populations of *Nemophila menziesii* during the 2021-2022 growing season of the Mazer lab's Nemophila project. 



**Load Packages**  

```{r message = FALSE}
library(tidyverse) #For data organization and tidying
library(janitor) #more tidying functions
library(here) #great for specifying relative file paths
library(lubridate) #for adjusting 'date' values if any need cleaning up
library(lme4)
library(corrplot)
library(jtools)

```



#### Load Fitness Plant Data  

**Bodega Bay**  

Load and tidy up data.
```{r}
## All data
BB_allplants <- read_csv(here::here("data_sheets", "compiled_sheets", "BB_mastersheet_full_2023-03-01.csv")) %>% select(-c(Sequence, Co., FitP, F_multi, F_plant_notes, Fl_2.25:flr_P, seeds_weighed_d1:msm_d9)) %>% 
  filter(Replicated == "R") %>% #Replicated genotypes only
  mutate(fl_duration = case_when(fl_duration == 0 ~ 1,
                                 TRUE ~ fl_duration)) %>%  #Replace durations of 0 with 1
  mutate(FFD_c = scale(yday(FFD), scale = FALSE)[,1], #convert to Julian day of year, but don't scale...
         fl_dur_c = scale(fl_duration, scale = FALSE)[,1], # Center all variables
         corolla_d_c = scale(corolla_diam_mm, scale = FALSE)[,1],
         AG_biom_c = scale(AG_biomass_mg, scale = FALSE)[,1],
         seed_ct_c = scale(seed_ct, scale = FALSE)[,1],
         lifet_fec_c = scale(total_est_seed_production, scale = FALSE)[,1]) %>% 
  mutate(FFD_z = scale(yday(FFD))[,1],
         fl_dur_z = scale(fl_duration)[,1], # Standardize all variables
         corolla_d_z = scale(corolla_diam_mm)[,1],
         AG_biom_z = scale(AG_biomass_mg)[,1],
         seed_ct_z = scale(seed_ct)[,1],
         lifet_fec_z = scale(total_est_seed_production)[,1]) %>% 
  mutate(seed_ct_r = seed_ct/mean(seed_ct),
         lifet_fec_r = total_est_seed_production/mean(total_est_seed_production)) %>% #fitness relative to population mean
  mutate(Treatment = as.factor(case_when(Block %in% c("1", "2", "3") ~ "ambient",
                               Block == "W" ~ "watered")),
         Treat_bin = as.numeric(case_when(Block %in% c("1", "2", "3") ~ 0, #binary var for treatment: ambient/watered = 0/1
                               Block == "W" ~ 1))) %>% 
  mutate(Recipient = as.factor(Recipient))



BB_allplants_f <- BB_allplants %>% 
  filter(!is.na(FFD_c)) #plants that flowered only

#318 obs vs 225 for fitness plants

##Fitness Plants Only
BB_Fplants <- BB_allplants %>% 
  filter(any_FitP == TRUE)

##Note on the data:
## This data frame includes data on all selected fitness plants at Bodega Bay from 2021-2022. There were 3 experimental blocks and a total of 156 (+1; 160) point-locations. Plants in block 'W' received supplemental water and had, when available, 3 fitness plants chosen. Recipient ID's (Genotypes) that were present in both the regular and water blocks had, when available, 3 fitness plants chosen (Replicated = R). Important trait-related columns include germination date, the number of closed fruit, number of total fruit, seed count, mean seed mass (msm_all), mean seeds per fruit, total estimated seed production, first flowering date (FFD), days from germination to flower, flowering duration, and survival.




######
## Exclude genotypes without observations from both treatments???


```

#### John M's Models
Statistical approaches matched to each of John's research questions for investigating plasticity in *N. menziesii*:  


1. What is the effect of supplemental water on functional traits and fitness in Nemophila menziesii?  

I.e.: What is the magnitude & direction of plastic changes in traits between ambient (dry) and watered plots?  

- Fecundity (seed count & estimated lifetime fecundity (mean seeds/fruit x total fruit))
- First flowering date
- Flowering duration (?)
- Corolla diameter
- Aboveground biomass

Variable Treatment: All traits mean-centered

Analysis: Calculate Regression coefficients for Trait ~ Treatment
Models:
- Bivariate
- Multivariate
- MV + random effects

```{r}
#####
#Statistical Tests
#####

### Bivariate Models

#Fecundity
PL_fec_lm1 <- lm(seed_ct_c ~ Treatment, data = BB_allplants)
summary(PL_fec_lm1)
PL_fec_lm2 <- lm(lifet_fec_c ~ Treatment, data = BB_allplants)
summary(PL_fec_lm2)

#FFD
PL_FFD_lm1 <- lm(FFD_c ~ Treatment, data = BB_allplants)
summary(PL_FFD_lm1)

#F duration
PL_Fdur_lm1 <- lm(fl_dur_c ~ Treatment, data = BB_allplants)
summary(PL_Fdur_lm1)

#Corolla diam
PL_Cdiam_lm1 <- lm(corolla_d_c ~ Treatment, data = BB_allplants)
summary(PL_C_diam_lm1)

##Multivariate Models



```

```{r}
#Visualizations

```



2. Is the strength and direction of plasticity in functional traits consistent (1) among populations and (2) within populations among genotypes? 

I.e: (a) At the population level, are plastic changes in traits with water addition consistent in direction and in magnitude? (b) Do plastic changes with watering among genotypes within populations mirror one another?  

**Note:** Use standardized trait values, but note that comparisons among populations (at least in magnitude) are fraught due to local climatic differences and differences in the amount of additional soil moisture actually experienced by watered plants relative to ambient plants at each site.  


```{r}
#####
#Statistical Tests
#####
```

```{r}
#Visualiztions


```



[(c)] Are certain traits more plastic than others, and is this consistent across populations?
 -- compare standardized coefficients


#### Early Exploration  

```{r}




#Examine the structure of the data set

str(BB_fitness_df3)

head(BB_fitness_df3)

summary(BB_fitness_df3)


#Number of observations: watered vs unwatered
nrow(filter(BB_fitness_df3, watered == "n"))
```


**Some questions**:
- How many watered v.s. non-watered fitness plants (observations) are there?
- On average, how many fitness plants are there to each Recipient ID (in each block)?
- What kind of trends in quantitative/numeric trait variables can you identify?
- How do trait values differ across locations and between experiments?




```{r}
lm1 <- lm(FFD_DOY ~ watered, data = BB_fitness_df3)

summary(lm1)

anova(lm1)


#TukeyHSD(aov(lm1))

ggplot()
```


```{r}

library(lme4)

lm_er1 <- lmer(FFD_DOY ~ watered + (1|Location) + (1|Recipient), data = BB_fitness_df3)

summary(lm_er1)

anova(lm_er1)


ggplot(data = BB_fitness_df3) %>% 
  geom_jitter(aes(x = watered, y = fl_duration))

```



